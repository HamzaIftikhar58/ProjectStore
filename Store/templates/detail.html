<!DOCTYPE html>
<html lang="en">
{% load static %}
{% load youtube_filters %}
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="{% static 'Images/circle.png' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ product.name }} | Shopping Cart</title>
  <meta name="description" content="{{ product.meta_description|default:product.short_description }}">
  <meta name="keywords" content="{{ product.meta_keywords|default:product.name }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"
    integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/easyzoom/2.5.2/easyzoom.min.css">
      <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style.css' %}">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
  />
  <style>
    body {
      font-family: Arial, sans-serif;
      overflow-x: hidden;
    }
    .form-select, .input-group {
      width: 100%;
      max-width: 150px;
    }

    #end {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 8px 12px;
      background: #fff;
      z-index: 9999;
    }
    #end .btn {
      min-height: 48px;
    }
    #end i {
      vertical-align: middle;
    }

    .like-button.liked i {
      color: red;
    }

    @media (max-width: 767px) {
      .gallery-thumbs {
        height: auto !important;
        flex-direction: row !important;
      }
      .gallery-thumbs .swiper-wrapper {
        flex-direction: row !important;
      }
      .gallery-thumbs .swiper-slide {
        width: 60px !important;
        height: 60px !important;
        overflow: hidden;
      }
      .gallery-thumbs .swiper-slide img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .gallery-top {
        height: 300px !important;
      }
    }
    @media (min-width: 768px) {
      .gallery-thumbs {
        height: 400px !important;
        flex-direction: column !important;
      }
      .gallery-thumbs .swiper-wrapper {
        flex-direction: column !important;
        display: flex;
      }
      .gallery-thumbs .swiper-slide {
        width: 80px !important;
        height: 80px !important;
        overflow: hidden;
      }
      .gallery-thumbs .swiper-slide img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .gallery-top {
        height: 410px !important;
      }
    }
    @media (max-width: 300px) {
      body {
        font-size: 12px;
      }
      .container-fluid {
        padding-left: 5px;
        padding-right: 5px;
      }
      .navbar-nav {
        flex-direction: column;
        align-items: center;
      }
      .navbar-brand img {
        width: 80px;
        height: auto;
      }
      .gallery-thumbs {
        height: auto !important;
        flex-direction: row !important;
      }
      .gallery-thumbs .swiper-wrapper {
        flex-direction: row !important;
      }
      .gallery-thumbs .swiper-slide {
        width: 40px !important;
        height: 40px !important;
        overflow: hidden;
      }
      .gallery-thumbs .swiper-slide img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .gallery-top {
        height: 200px !important;
      }
      .col-md-1, .col-md-3, .col-md-5, .col-md-3 {
        flex: 0 0 100% !important;
        max-width: 100% !important;
      }
      .border {
        padding: 5px !important;
      }
      .form-select, .input-group {
        max-width: 100% !important;
        font-size: 12px;
      }
      .btn {
        font-size: 12px;
        padding: 4px 8px;
      }
      #priceDisplay {
        font-size: 16px !important;
      }
      .fs-4, .fs-5 {
        font-size: 14px !important;
      }
      .color-option {
        width: 50px !important;
      }
      #end {
        padding: 4px 6px;
      }
      #end .btn {
        min-height: 36px;
        font-size: 12px;
      }
      .cart-sidebar {
        max-width: 100% !important;
        width: 100% !important;
      }
      .cart-item img {
        width: 30px !important;
        height: 30px !important;
      }
      .cart-item h6 {
        font-size: 12px;
      }
      .cart-item p {
        font-size: 10px;
      }
    }
    .cart-sidebar {
      width: 100%;
      max-width: 390px;
      height: 100%;
      position: fixed;
      top: 0;
      right: -100%;
      background: #fff;
      box-shadow: -2px 0 5px rgba(0,0,0,0.5);
      transition: right 0.3s ease;
      z-index: 10000;
    }
    .cart-sidebar.open {
      right: 0;
    }
    .swiper-slide img, .swiper-slide video {
      width: 100%;
      height: auto;
      object-fit: contain;
    }
    /* Notification styles */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: #28a745;
      color: white;
      padding: 15px 25px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 99999;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
    }
    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }
    .notification.error {
      background-color: #dc3545;
    }
    .notification i {
      margin-right: 10px;
      font-size: 1.2em;
    }
    /* Review system styles */
    .review-container {
      max-height: 400px;
      overflow-y: auto;
    }
    .review-card {
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: #fff;
    }
    .review-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .review-author {
      font-weight: bold;
    }
    .review-date {
      color: #6c757d;
      font-size: 0.9em;
    }
    .star-rating {
      color: #ffc107;
    }
    .review-form {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 5px;
    }
    .rating-input {
      display: flex;
      flex-direction: row-reverse;
      justify-content: flex-end;
    }
    .rating-input input {
      display: none;
    }
    .rating-input label {
      font-size: 1.5em;
      color: #ddd;
      cursor: pointer;
      margin-right: 5px;
    }
    .rating-input input:checked ~ label {
      color: #ffc107;
    }
    .rating-input label:hover,
    .rating-input label:hover ~ label {
      color: #ffc107;
    }
    /* Share Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fff;
      padding: 20px;
      border-radius: 5px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .close-share {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      cursor: pointer;
    }
    .share-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .share-option {
      padding: 10px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    .share-option:hover {
      background-color: #0056b3;
    }
    .order-whatsapp {
      background-color: #25D366;
    }
    .order-whatsapp:hover {
      background-color: #1DA851;
    }
    /* Auth Modal Styles */
    #authModal .form-control:focus {
      border-color: #28a745;
      box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    #authModal .invalid-feedback {
      display: block;
    }
    #authModal a {
      color: #28a745;
      text-decoration: none;
      font-weight: 500;
    }
    #authModal a:hover {
      text-decoration: underline;
    }
    #authModal .alert {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  {% include 'Includes/navbar.html' %}
  
  <!-- Notification div -->
  <div id="notification" class="notification">
    <i class="fas fa-check-circle"></i>
    <span id="notification-message"></span>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal ">
    <div class="modal-content">
      <span class="close-share">&times;</span>
      <h3>Share this product</h3>
      <div class="share-options">
        <button class="share-option" data-type="facebook">Share on Facebook</button>
        <button class="share-option" data-type="twitter">Share on Twitter</button>
        <button class="share-option" data-type="whatsapp">Share on WhatsApp</button>
        <button class="share-option order-whatsapp" data-type="order-whatsapp">Order via WhatsApp</button>
        <button class="share-option" data-type="link">Copy Link</button>
      </div>
    </div>
  </div>

  <!-- Breadcrumb -->
  <div class="container-fluid bg-light">
  <div class="container px-2 px-md-3">
    <div class="row py-4 py-md-1">
      <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='%236c757d'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
        <ol class="breadcrumb text-center text-md-start">
          <!-- Dynamic Products/Projects link -->
          <li class="breadcrumb-item d-flex flex-wrap">
            {% if is_project %}
              <a href="{% url 'project' %}" class="text-decoration-none fs-5 d-none d-md-inline">Projects</a>
              <a href="{% url 'project' %}" class="text-decoration-none fs-6 d-inline d-md-none">Projects</a>
            {% else %}
              <a href="{% url 'product' %}" class="text-decoration-none fs-5 d-none d-md-inline">Products</a>
              <a href="{% url 'product' %}" class="text-decoration-none fs-6 d-inline d-md-none">Products</a>
            {% endif %}
          </li>

          <!-- Active page (Cart / Detail etc.) -->
          <li class="breadcrumb-item active d-flex flex-wrap" aria-current="page">
            <span class="fs-5 d-none d-md-inline">{{ page_title }}</span>
            <span class="fs-6 d-inline d-md-none">{{ page_title }}</span>
          </li>
        </ol>
      </nav>
    </div>
  </div>
</div>

  <!-- Product Showcase -->
  <div class="container-fluid px-2 px-md-5">
    <div class="row">
      <!-- Thumbnail Gallery -->
      <div class="col-md-1 mt-4 order-2 order-md-1">
        <div class="border p-3">
          <div class="swiper gallery-thumbs">
            <div class="swiper-wrapper">
              <div class="swiper-slide border"><img src="{{ product.main_image.url }}" alt="{{ product.get_alt_text }}" class="img-fluid" style='object-fit:contain;'></div>
              {% for image in product.images.all %}
              <div class="swiper-slide border"><img src="{{ image.image.url }}" alt="{{ image.get_alt_text }}" class="img-fluid" style='object-fit:contain;'></div>
              {% endfor %}
              {% for variant in product.variants.all %}
              <div class="swiper-slide border"><img src="{{ variant.image.url }}" alt="{{ variant.get_alt_text }}" class="img-fluid" style='object-fit:contain;'></div>
              {% endfor %}
              {% if product.youtube_video_url %}
              <div class="swiper-slide border">
                <iframe width="100%" height="100%" src="{{ product.youtube_video_url|youtube_embed_url }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="object-fit: cover;"></iframe>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- Main Image Gallery -->
      <div class="col-md-3 order-1 order-md-2">
        <div class="border mt-3 mt-md-4 p-3">
          <div class="swiper gallery-top">
            <div class="swiper-wrapper">
              <div class="swiper-slide"><img src="{{ product.main_image.url }}" alt="{{ product.get_alt_text }}" class="img-fluid" style='object-fit:contain;' data-price="{{ product.price }}"></div>
                {% for image in product.images.all %}
              <div class="swiper-slide border"><img src="{{ image.image.url }}" alt="{{ image.get_alt_text }}" class="img-fluid" style='object-fit:contain;'></div>
              {% endfor %}
              {% for variant in product.variants.all %}
              <div class="swiper-slide"><img src="{{ variant.image.url }}" alt="{{ variant.get_alt_text }}" class="img-fluid" style='object-fit:contain;' data-price="{{ variant.price }}"></div>
              {% endfor %}
              {% if product.youtube_video_url %}
              <div class="swiper-slide">
                <div class="ratio ratio-16x9">
                  <iframe src="{{ product.youtube_video_url|youtube_embed_url }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
              </div>
              {% else %}
              <div>No video URL available.</div>
              {% endif %}
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
          </div>
        </div>
      </div>

      <!-- Product Details -->
      <div class="col-md-5 mt-4 order-4 order-md-3">
        <div class="border p-3">
          <p class="fs-5 mt-3">SKU: {{ product.sku }}</p>
          <p class="fs-5">{{ product.short_description }}</p>
         <div class="d-flex align-items-center gap-3">
  {% if product.discount_percentage > 0 %}
    <!-- Original Price -->
    <p class="text-muted text-decoration-line-through mb-0">
      RS: {{ product.price }}
    </p>
    <!-- Discounted Price -->
    <p id="priceDisplay" class="display-4 fs-4 mb-0">
      <strong class="fw-bold text-danger">RS: {{ product.final_price }}</strong>
    </p>
    <!-- Discount Badge -->
    <span class="badge bg-success fs-6">-{{ product.discount_percentage }}%</span>
  {% else %}
    <!-- Normal Price -->
    <p id="priceDisplay" class="display-4 fs-4 mb-0">
      <strong class="fw-bold">RS: {{ product.price }}</strong>
    </p>
  {% endif %}
</div>

          <hr>
          {% if product.variants.all %}
          <form class="d-flex">
            <label for="myColor" class="form-label mt-4 mx-2 fs-5 fw-bold">Choose Variant:</label>
            <div class="d-flex">
              {% for variant in product.variants.all %}
              <img src="{{ variant.image.url }}" alt="{{ variant.get_alt_text }}" class="img-thumbnail mx-1 color-option" width="60" data-slide-index="{{ forloop.counter0 }}" data-price="{{ variant.price }}" data-variant-id="{{ variant.id }}">
              {% endfor %}
            </div>
          </form>
          {% else %}
          <p class="text-danger">No variants available for this product.</p>
          {% endif %}
          <hr>
          <h1 class="mt-3 text-start">Description</h1>
          <p class="fs-5" style="text-align:justify;">{{ product.description }}</p>
          {% if product.features %}
          <p class="fw-bold fs-5">Key Features:</p>
          <ul class="fs-5">
            {% for feature in product.features.all %}
            <li>{{ feature.feature }}</li>
            {% endfor %}
          </ul>
          {% endif %}
          {% if product.specifications %}
          <p class="fw-bold fs-5">Specifications:</p>
          <ul class="fs-5">
            {% for specification in product.specifications.all %}
            <li>{{ specification.key }}: {{ specification.value }}</li>
            {% endfor %}
          </ul>
          {% endif %}
        </div>
      </div>

      <!-- Product Actions -->
      <div class="col-12 col-md-3 mt-4 order-3 order-md-4">
        <div class="border p-3">
          <div class="text-center">
            <p class='fw-bold fs-6'>{{ product.name }}</p>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <h6>Quantity</h6>
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(-1, 'quantity')">-</button>
              <input type="text" id="quantity" class="form-control text-center" value="1" readonly>
              <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(1, 'quantity')">+</button>
            </div>
          </div>
          <hr>
       {% if product.category.name|lower == "electronics" or product.category.name|lower == "robot" %}
<div class="d-flex justify-content-between">
  <h3>Stock</h3>
  {% if product.stock %}
  <h3 class="fs-5 mt-1">{{ product.stock }} Available</h3>
  {% else %}
  <h3 class="fs-5 mt-1 text-danger">Out of Stock</h3>
  {% endif %}
</div>
{% endif %}

          <div class="">
            {% if request.user.is_authenticated %}
            <button class="btn btn-success w-100 mt-2 py-2 add-to-cart d-none d-md-block" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}">Add to Cart</button>
            {% else %}
            <button class="btn btn-success w-100 mt-2 py-2 add-to-cart-unauth d-none d-md-block" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}">
              Add to Cart
            </button>
            {% endif %}
             {% if request.user.is_authenticated %}
            <button class="btn btn-success w-100 mt-2 py-2 order-whatsapp d-none d-md-block" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}"><i class="fab fa-whatsapp me-2"></i>Order via WhatsApp</button>
            {% else %}
            <button class="btn btn-success w-100 mt-2 py-2 order-whatsapp-unauth d-none d-md-block" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}"><i class="fab fa-whatsapp me-2"></i>Order via WhatsApp</button>
            {% endif %}
            <div class="d-flex flex-column flex-sm-row justify-content-between mt-2">
              <button class="btn btn-danger w-50 me-sm-0 mb-2 mb-sm-0 py-2  share-button" data-product-id="{{ product.id }}"><i class="fa-solid fa-share me-2"></i>Share</button>
              
              {% if request.user.is_authenticated %}
              <button class="btn btn-primary w-50 py-2  like-button" 
                      data-product-id="{{ product.id }}"
                      {% if request.user.is_authenticated and product.is_liked_by_user %}data-liked="true"{% endif %}>
                <i class="fa-solid fa-heart me-2"></i>
                <span class="like-text">{% if request.user.is_authenticated and product.is_liked_by_user %}Unlike{% else %}Like{% endif %}</span>
                (<span class="like-count">{{ product.like_count }}</span>)
              </button>
              {% else %}
              <button class="btn btn-primary w-50 py-2 like-button-unauth" data-product-id="{{ product.id }}">
                <i class="fa-solid fa-heart me-2"></i>Like (<span class="like-count">{{ product.like_count }}</span>)
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-block d-md-none" id="end">
    <div class="d-flex flex-row justify-content-between align-items-stretch mt-0">
      {% if request.user.is_authenticated %}
      <button class="btn btn-success w-50 py-0 add-to-cart mx-1" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}"><i class="fa-solid fa-cart-shopping me-2"></i>Add to Cart</button>
      <button class="btn btn-success w-50 py-0 order-whatsapp mx-1" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}"><i class="fab fa-whatsapp me-2"></i>Order via WhatsApp</button>
      {% else %}
      <button class="btn btn-success w-50 py-0 add-to-cart-unauth mx-1" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}"><i class="fa-solid fa-cart-shopping me-2"></i>Add to Cart</button>
      <button class="btn btn-success w-50 py-0 order-whatsapp-unauth mx-1" data-name="{{ product.name }}" data-price="{{ product.price }}" data-product-id="{{ product.id }}"><i class="fab fa-whatsapp me-2"></i>Order via WhatsApp</button>
      {% endif %}
    </div>
  </div>

  <!-- Customer Reviews -->
  <div class="container-fluid mt-5 border p-4 rounded shadow-sm bg-light">
    <h2 class="text-center mb-4">Customer Reviews</h2>
    <div class="row">
      <div class="col-md-2"></div>
      <div class="col-md-4 p-4">
        <div class="p-6 bg-white rounded shadow-sm">
          <div class="d-flex align-items-center mb-3 p-1">
            <h4 class="me-2 mb-0">{{ avg_rating }}</h4>
            <div class="text-warning fs-4">
              {% for _ in full_stars %}
                <i class="fas fa-star"></i>
              {% endfor %}
              {% if half_star %}
                <i class="fas fa-star-half-alt"></i>
              {% endif %}
              {% for _ in empty_stars %}
                <i class="far fa-star"></i>
              {% endfor %}
            </div>
            <p class="ms-2 mb-0">({{ reviews.count }} reviews)</p>
          </div>
          <div class="review-container">
            {% for review in reviews %}
              <div class="review-card border rounded p-2 mb-2">
                <div class="review-header d-flex justify-content-between">
                  <span class="fw-bold">{{ review.reviewer_name }}</span>
                  <span class="text-muted">{{ review.created_at|date:"M d, Y" }}</span>
                </div>
                <div class="star-rating text-warning">
                  {% for _ in "12345" %}
                    {% if forloop.counter <= review.rating %}
                      <i class="fas fa-star"></i>
                    {% elif review.rating|add:"0.5" >= forloop.counter %}
                      <i class="fas fa-star-half-alt"></i>
                    {% else %}
                      <i class="far fa-star"></i>
                    {% endif %}
                  {% endfor %}
                </div>
                <p class="review-text">{{ review.review }}</p>
              </div>
            {% empty %}
              <p class='p-1'>No reviews yet. Be the first to review!</p>
            {% endfor %}
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="review-form">
          <h3 class="mb-3 text-center">Write a Review</h3>
          <form id="reviewForm" method="post" action="{% url 'submit_review' product.id %}">
            {% csrf_token %}
            <div class="mb-3">
              <label for="name" class="form-label">Your Name</label>
              <input type="text" class="form-control" id="name" value="{{ request.user.username }}" name="reviewer_name" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Rating</label>
              <div class="rating-input">
                {% for i in "54321" %}
                  <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required/>
                  <label for="star{{ i }}" title="{{ i }} stars">â˜…</label>
                {% endfor %}
              </div>
            </div>
            <div class="mb-3">
              <label for="review" class="form-label">Your Review</label>
              <textarea class="form-control" id="review" name="review" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-success w-100">Submit Review</button>
          </form>
        </div>
      </div>
      <div class="col-md-2"></div>
    </div>
  </div>

  <!-- Cart Sidebar -->
  <div class="cart-sidebar" id="cartSidebar">
    <button class="btn-close float-end mt-3" id="closeCart"></button>
    <div class="p-3">
      <h5>Shopping Cart</h5>
    </div>
    <div id="cartItems" class="px-3"></div>
    <div class="p-3">
      <p><strong>Subtotal:</strong> Rs <span id="cartTotal">0</span> PKR</p>
      <a class="btn btn-success w-100" href="{% url 'checkout' %}">Checkout</a>
    </div>
  </div>

  {% include 'Includes/footer.html' %}



 <!-- Login/Register Modal for Add to Cart -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title">Login Required</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <!-- Login Form -->
        <div id="loginFormContainer">
          <form id="loginForm" method="POST" action="{% url 'ajax_login' %}?next={{ request.path }}">
            {% csrf_token %}
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input type="text" class="form-control" id="username" name="username" required>
              <div id="usernameError" class="invalid-feedback"></div>
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input type="password" class="form-control" id="password" name="password" required>
              <div id="passwordError" class="invalid-feedback"></div>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="remember" name="remember">
              <label class="form-check-label" for="remember">Remember me</label>
            </div>
            <div id="loginError" class="alert alert-danger d-none" role="alert"></div>
            <button type="submit" class="btn btn-success w-100" id="loginButton">
              <span id="loginSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
              Login
            </button>
          </form>
          
          <div class="text-center mt-3">
            <p class="mb-1">Don't have an account? 
              <a href="{% url 'register' %}" id="showRegister">Register here</a>
            </p>
            <p class="mb-0">
              <a href="{% url 'password_reset' %}">Forgot Password?</a>
            </p>
          </div>
        </div>

        <!-- Registration Form (hidden by default) -->
        <div id="registerFormContainer" class="d-none">
          <form id="registerForm" method="POST" action="{% url 'ajax_register' %}">
            {% csrf_token %}
            <div class="mb-3">
              <label for="reg_username" class="form-label">Username</label>
              <input type="text" class="form-control" id="reg_username" name="username" required>
              <div id="regUsernameError" class="invalid-feedback"></div>
            </div>
            <div class="mb-3">
              <label for="reg_email" class="form-label">Email</label>
              <input type="email" class="form-control" id="reg_email" name="email" required>
              <div id="regEmailError" class="invalid-feedback"></div>
            </div>
            <div class="mb-3">
              <label for="reg_password" class="form-label">Password</label>
              <input type="password" class="form-control" id="reg_password" name="password" required>
              <div id="regPasswordError" class="invalid-feedback"></div>
            </div>
            <div class="mb-3">
              <label for="reg_confirm_password" class="form-label">Confirm Password</label>
              <input type="password" class="form-control" id="reg_confirm_password" name="confirm_password" required>
              <div id="regConfirmPasswordError" class="invalid-feedback"></div>
            </div>
            <div id="registerError" class="alert alert-danger d-none" role="alert"></div>
            <button type="submit" class="btn btn-success w-100" id="registerButton">
              <span id="registerSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
              Register
            </button>
          </form>
          
          <div class="text-center mt-3">
            <p class="mb-0">Already have an account? 
              <a href="javascript:void(0);" id="showLogin">Login here</a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Scripts -->
 <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Get CSRF token for AJAX requests
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Notification function
function showNotification(message, isError = false) {
  const notification = document.getElementById('notification');
  const notificationMessage = document.getElementById('notification-message');
  
  notification.className = 'notification';
  if (isError) {
    notification.classList.add('error');
    notification.innerHTML = '<i class="fas fa-exclamation-circle"></i><span id="notification-message">' + message + '</span>';
  } else {
    notification.innerHTML = '<i class="fas fa-check-circle"></i><span id="notification-message">' + message + '</span>';
  }
  
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Cart Functionality
const cartSidebar = document.getElementById("cartSidebar");
const cartItems = document.getElementById("cartItems");
const cartTotal = document.getElementById("cartTotal");

// Open Cart Sidebar
document.querySelectorAll("[id^=cartIcon]").forEach(icon => {
  icon.addEventListener("click", function (event) {
    event.preventDefault();
    openCart();
    fetchCartItems();
  });
});

// Close Sidebar
document.getElementById("closeCart").addEventListener("click", function () {
  closeCart();
});

function openCart() {
  cartSidebar.classList.add("open");
}

function closeCart() {
  cartSidebar.classList.remove("open");
}

// Add Item to Cart via AJAX
function addItemToCart(name, price, productId, quantity, variantId, image = "{% static 'Images/download.jpeg' %}") {
  $.ajax({
    url: "{% url 'add_to_cart' %}",
    type: "POST",
    headers: {
      'X-CSRFToken': csrftoken
    },
    data: {
      product_id: productId,
      quantity: quantity,
      variant_id: variantId
    },
    success: function(response) {
      if (response.success) {
        fetchCartItems();
        updateCartCount();
        showNotification(
          `${name} added to cart! Price: RS ${response.final_price}`
        );
        openCart();
      } else {
        console.error("Error adding item:", response.message);
        showNotification("Error: " + response.message, true);
      }
    },
    error: function(xhr) {
      console.error("Error adding item to cart:", xhr.status, xhr.statusText);
      showNotification("An error occurred while adding the item to the cart.", true);
    }
  });
}

// Fetch and display cart items
function fetchCartItems() {
  $.ajax({
    url: "{% url 'get_cart' %}",
    type: "GET",
    success: function(response) {
      cartItems.innerHTML = "";
      let total = 0;
      if (response.items && Array.isArray(response.items)) {
        response.items.forEach(item => {
          const itemElement = document.createElement("div");
          itemElement.classList.add("cart-item", "d-flex", "justify-content-between", "align-items-center", "mb-3");
          itemElement.innerHTML = `
            <div class="d-flex align-items-center">
              <img src="${item.image || "{% static 'Images/download.jpeg' %}"}" alt="${item.name}" width="50" height="50" class="me-3">
              <div>
                <h6 class="mb-0">${item.name}</h6>
                <p class="mb-0">Rs ${item.price.toFixed(2)} </p>
              </div>
            </div>
            <div class="d-flex align-items-center">
              <button class="btn btn-sm btn-outline-secondary minus-btn" data-item-id="${item.id}">
                <i class="bi bi-dash"></i>
              </button>
              <span class="mx-2 quantity">${item.quantity}</span>
              <button class="btn btn-sm btn-outline-secondary plus-btn" data-item-id="${item.id}">
                <i class="bi bi-plus"></i>
              </button>
              <button class="btn btn-danger btn-sm delete-item ms-3" data-item-id="${item.id}">
                <i class="bi bi-trash fs-4"></i>
              </button>
            </div>
          `;
          cartItems.appendChild(itemElement);
          total += item.price * item.quantity;
        });
      }
      cartTotal.textContent = total.toFixed(2);
      updateCartCount();
    },
    error: function(xhr) {
      console.error("Error fetching cart:", xhr.status, xhr.statusText);
      showNotification("An error occurred while fetching the cart.", true);
    }
  });
}

// Update quantity in cart
cartItems.addEventListener("click", function(e) {
  if (e.target.closest(".minus-btn") || e.target.closest(".plus-btn")) {
    const button = e.target.closest("button");
    const itemId = button.dataset.itemId;
    const change = button.classList.contains("minus-btn") ? -1 : 1;
    updateCartItemQuantity(itemId, change);
  }
  if (e.target.closest(".delete-item")) {
    const itemId = e.target.closest(".delete-item").dataset.itemId;
    removeCartItem(itemId);
  }
});

function updateCartItemQuantity(itemId, change) {
  $.ajax({
    url: "{% url 'update_cart' %}",
    type: "POST",
    headers: {
      'X-CSRFToken': csrftoken
    },
    data: {
      item_id: itemId,
      change: change
    },
    success: function(response) {
      if (response.success) {
        fetchCartItems();
      } else {
        console.error("Error updating item:", response.message);
        showNotification("Error: " + response.message, true);
      }
    },
    error: function(xhr) {
      console.error("Error updating cart:", xhr.status, xhr.statusText);
      showNotification("An error occurred while updating the cart.", true);
    }
  });
}

function removeCartItem(itemId) {
  $.ajax({
    url: "{% url 'remove_from_cart' %}",
    type: "POST",
    headers: {
      'X-CSRFToken': csrftoken
    },
    data: {
      item_id: itemId
    },
    success: function(response) {
      if (response.success) {
        fetchCartItems();
        showNotification("Item removed from cart");
      } else {
        console.error("Error removing item:", response.message);
        showNotification("Error: " + response.message, true);
      }
    },
    error: function(xhr) {
      console.error("Error removing item:", xhr.status, xhr.statusText);
      showNotification("An error occurred while removing the item.", true);
    }
  });
}

function updateCartCount() {
  fetch("{% url 'cart_count' %}?t=" + new Date().getTime())
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('Cart count data:', data);
      document.querySelectorAll('.cartCount').forEach(el => {
        el.textContent = data.count || 0;
        el.style.display = (data.count && data.count > 0) ? 'inline-block' : 'none';
      });
    })
    .catch(err => {
      console.error('Error fetching cart count:', err);
      showNotification('Failed to update cart count', true);
    });
}

function updateQuantity(change, inputId) {
  let quantityInput = document.getElementById(inputId);
  let value = parseInt(quantityInput.value);
  if (value + change >= 1) {
    quantityInput.value = value + change;
  }
}

// =========== AUTHENTICATION HANDLING ===========

// Handle unauthenticated add-to-cart buttons (desktop)
document.querySelectorAll(".add-to-cart-unauth").forEach(button => {
  button.addEventListener("click", function () {
    // Show auth modal
    const authModal = new bootstrap.Modal(document.getElementById('authModal'));
    authModal.show();
    
    // Store cart data in modal for later use
    const modal = document.getElementById('authModal');
    modal.dataset.productId = this.dataset.productId;
    modal.dataset.name = this.dataset.name;
    modal.dataset.price = this.dataset.price;
    modal.dataset.quantity = document.getElementById("quantity").value;
    
    // Store variant info
    const variantElement = document.querySelector(".color-option.active");
    if (variantElement) {
      modal.dataset.variantId = variantElement.dataset.variantId;
    }
    
    return false;
  });
});

// Handle authenticated add-to-cart buttons
document.querySelectorAll(".add-to-cart").forEach(button => {
  button.addEventListener("click", function () {
    const name = this.dataset.name;
    const price = parseFloat(this.dataset.price);
    const productId = this.dataset.productId;
    const quantity = parseInt(document.getElementById("quantity").value);
    const variantId = document.querySelector(".color-option.active")?.dataset.variantId || null;
    const image = document.querySelector(".gallery-top .swiper-slide-active img")?.src || "{% static 'Images/download.jpeg' %}";
    
    addItemToCart(name, price, productId, quantity, variantId, image);
  });
});

// Handle unauthenticated order via WhatsApp buttons
document.querySelectorAll(".order-whatsapp-unauth").forEach(button => {
  button.addEventListener("click", function () {
    // Show auth modal
    const authModal = new bootstrap.Modal(document.getElementById('authModal'));
    authModal.show();
    
    // Store WhatsApp order data
    const modal = document.getElementById('authModal');
    modal.dataset.action = 'whatsapp_order';
    modal.dataset.productId = this.dataset.productId;
    modal.dataset.name = this.dataset.name;
    modal.dataset.price = this.dataset.price;
    modal.dataset.quantity = document.getElementById("quantity").value;
    
    return false;
  });
});

// Handle authenticated order via WhatsApp buttons
document.querySelectorAll(".order-whatsapp").forEach(button => {
  button.addEventListener("click", function () {
    const name = this.dataset.name;
    const price = parseFloat(this.dataset.price);
    const productId = this.dataset.productId;
    const quantity = parseInt(document.getElementById("quantity").value);
    const variantId = document.querySelector(".color-option.active")?.dataset.variantId || null;
    const variantImage = document.querySelector(".color-option.active")?.src || null;
    const productUrl = `${window.location.origin}/products/${productId}/`;
    
    let message = `Hello, I would like to order the following product:\n`;
    message += `Product: ${name}\n`;
    message += `Price: Rs ${price.toFixed(2)} PKR\n`;
    message += `Quantity: ${quantity}\n`;
    if (variantId && variantImage) {
      message += `Variant: ${variantImage}\n`;
    }
    message += `Product Link: ${productUrl}\n`;
    message += ``;

    const whatsappNumber = '+923104505008';
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');

    // Track the WhatsApp order action
    fetch(`/track-whatsapp-order/${productId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      console.log('WhatsApp order tracked:', data);
      showNotification('Order request sent via WhatsApp!');
    })
    .catch(error => {
      console.error('Error tracking WhatsApp order:', error);
      showNotification('Order request sent, but tracking failed.', true);
    });
  });
});

// Handle unauthenticated like buttons
document.querySelectorAll(".like-button-unauth").forEach(button => {
  button.addEventListener('click', function() {
    // Show auth modal
    const authModal = new bootstrap.Modal(document.getElementById('authModal'));
    authModal.show();
    
    // Store like data
    const modal = document.getElementById('authModal');
    modal.dataset.action = 'like';
    modal.dataset.productId = this.dataset.productId;
    
    return false;
  });
});

// Handle authenticated like buttons
document.querySelectorAll('.like-button').forEach(button => {
  button.addEventListener('click', function() {
    const productId = this.dataset.productId;
    const isLiked = this.dataset.liked === 'true';
    const likeText = this.querySelector('.like-text');
    const likeCount = this.querySelector('.like-count');
    
    fetch(`/toggle-like/${productId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Content-Type': 'application/json'
      },
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      if (data.liked) {
        this.dataset.liked = 'true';
        likeText.textContent = 'Unlike';
        this.classList.add('liked');
      } else {
        this.dataset.liked = 'false';
        likeText.textContent = 'Like';
        this.classList.remove('liked');
      }
      if (likeCount) {
        likeCount.textContent = data.count;
      }
      showNotification(data.liked ? 'Added to favorites' : 'Removed from favorites');
    })
    .catch(error => {
      console.error('Error:', error);
      showNotification('An error occurred while liking the product.', true);
    });
  });
});

// =========== MOBILE BUTTON HANDLING ===========

// Mobile add-to-cart buttons
document.querySelectorAll('#end .add-to-cart').forEach(button => {
  button.addEventListener('click', function () {
    const name = this.dataset.name;
    const price = parseFloat(this.dataset.price);
    const productId = this.dataset.productId;
    const quantity = parseInt(document.getElementById("quantity").value);
    const variantId = document.querySelector(".color-option.active")?.dataset.variantId || null;
    const image = document.querySelector(".gallery-top .swiper-slide-active img")?.src || "{% static 'Images/download.jpeg' %}";
    
    addItemToCart(name, price, productId, quantity, variantId, image);
  });
});

// Mobile unauthenticated add-to-cart buttons
document.querySelectorAll('#end .add-to-cart-unauth').forEach(button => {
  button.addEventListener("click", function () {
    // Show auth modal
    const authModal = new bootstrap.Modal(document.getElementById('authModal'));
    authModal.show();
    
    // Store cart data in modal for later use
    const modal = document.getElementById('authModal');
    modal.dataset.productId = this.dataset.productId;
    modal.dataset.name = this.dataset.name;
    modal.dataset.price = this.dataset.price;
    modal.dataset.quantity = document.getElementById("quantity").value;
    
    // Store variant info
    const variantElement = document.querySelector(".color-option.active");
    if (variantElement) {
      modal.dataset.variantId = variantElement.dataset.variantId;
    }
    
    return false;
  });
});

// =========== MODAL FORM HANDLING ===========

// Handle login form submission
document.getElementById('loginForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const loginButton = document.getElementById('loginButton');
  const loginSpinner = document.getElementById('loginSpinner');
  
  // Show loading
  loginButton.disabled = true;
  loginSpinner.classList.remove('d-none');
  
  // Clear previous errors
  document.getElementById('loginError').classList.add('d-none');
  document.querySelectorAll('#loginForm input').forEach(input => {
    input.classList.remove('is-invalid');
  });
  
  console.log('Sending login request to:', this.action);
  console.log('Form data:', Object.fromEntries(formData));
  
  fetch(this.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': csrftoken
    },
    credentials: 'same-origin' // Important: include cookies
  })
  .then(response => {
    console.log('Login response status:', response.status);
    console.log('Login response headers:', response.headers);
    
    // First, get the response text to see what's actually returned
    return response.text().then(text => {
      console.log('Login response text:', text);
      
      // Try to parse as JSON
      try {
        return JSON.parse(text);
      } catch (error) {
        console.error('Failed to parse JSON:', error);
        console.error('Raw response:', text);
        throw new Error('Server returned invalid JSON: ' + text.substring(0, 100));
      }
    });
  })
  .then(data => {
    console.log('Login parsed data:', data);
    
    if (data.success) {
      // Login successful
      showNotification('Login successful!');
      
      const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
      const modal = document.getElementById('authModal');
      
      // Get stored data from modal
      const productId = modal.dataset.productId;
      const name = modal.dataset.name;
      const price = parseFloat(modal.dataset.price);
      const quantity = parseInt(modal.dataset.quantity || document.getElementById("quantity").value);
      const variantId = modal.dataset.variantId || document.querySelector(".color-option.active")?.dataset.variantId || null;
      const action = modal.dataset.action || 'add_to_cart';
      
      // Close modal
      authModal.hide();
      
      // Wait for session to be fully established and page to update
      setTimeout(() => {
        // Refresh the page to update authentication state
        window.location.reload();
        
        // After reload, the authenticated user can add to cart
        // Store the cart action in sessionStorage to be executed after reload
        if (action === 'add_to_cart') {
          sessionStorage.setItem('pendingCartAction', JSON.stringify({
            productId: productId,
            name: name,
            price: price,
            quantity: quantity,
            variantId: variantId,
            action: 'add_to_cart'
          }));
        } else if (action === 'whatsapp_order') {
          sessionStorage.setItem('pendingCartAction', JSON.stringify({
            productId: productId,
            name: name,
            price: price,
            quantity: quantity,
            variantId: variantId,
            action: 'whatsapp_order'
          }));
        }
      }, 1000);
      
    } else {
      // Show errors
      const loginError = document.getElementById('loginError');
      loginError.textContent = data.message || 'Login failed';
      loginError.classList.remove('d-none');
      
      // Show field-specific errors
      if (data.errors) {
        Object.keys(data.errors).forEach(field => {
          const input = document.getElementById(field);
          const errorDiv = document.getElementById(field + 'Error');
          if (input && errorDiv) {
            input.classList.add('is-invalid');
            errorDiv.textContent = data.errors[field];
          }
        });
      }
    }
  })
  .catch(error => {
    console.error('Login fetch error:', error);
    const loginError = document.getElementById('loginError');
    loginError.textContent = 'Error: ' + error.message;
    loginError.classList.remove('d-none');
  })
  .finally(() => {
    loginButton.disabled = false;
    loginSpinner.classList.add('d-none');
  });
});

// Handle registration form submission
document.getElementById('registerForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const registerButton = document.getElementById('registerButton');
  const registerSpinner = document.getElementById('registerSpinner');
  
  // Show loading
  registerButton.disabled = true;
  registerSpinner.classList.remove('d-none');
  
  // Clear previous errors
  document.getElementById('registerError').classList.add('d-none');
  document.querySelectorAll('#registerForm input').forEach(input => {
    input.classList.remove('is-invalid');
  });
  
  console.log('Sending register request to:', this.action);
  console.log('Form data:', Object.fromEntries(formData));
  
  fetch(this.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': csrftoken
    },
    credentials: 'same-origin'
  })
  .then(response => {
    console.log('Register response status:', response.status);
    console.log('Register response headers:', response.headers);
    
    // First, get the response text to see what's actually returned
    return response.text().then(text => {
      console.log('Register response text:', text);
      
      // Try to parse as JSON
      try {
        return JSON.parse(text);
      } catch (error) {
        console.error('Failed to parse JSON:', error);
        console.error('Raw response:', text);
        throw new Error('Server returned invalid JSON: ' + text.substring(0, 100));
      }
    });
  })
  .then(data => {
    console.log('Register parsed data:', data);
    
    if (data.success) {
      // Registration successful - auto login
      showNotification('Registration successful! Logging you in...');
      
      // Auto login with the same credentials
      const username = document.getElementById('reg_username').value;
      const password = document.getElementById('reg_password').value;
      
      const loginFormData = new FormData();
      loginFormData.append('username', username);
      loginFormData.append('password', password);
      loginFormData.append('csrfmiddlewaretoken', csrftoken);
      
      return fetch("{% url 'ajax_login' %}?next={{ request.path }}", {
        method: 'POST',
        body: loginFormData,
        headers: {
          'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(loginData => {
        if (loginData.success) {
          const authModal = bootstrap.Modal.getInstance(document.getElementById('authModal'));
          const modal = document.getElementById('authModal');
          
          // Get stored data from modal
          const productId = modal.dataset.productId;
          const name = modal.dataset.name;
          const price = parseFloat(modal.dataset.price);
          const quantity = parseInt(modal.dataset.quantity || document.getElementById("quantity").value);
          const variantId = modal.dataset.variantId || document.querySelector(".color-option.active")?.dataset.variantId || null;
          const action = modal.dataset.action || 'add_to_cart';
          
          // Close modal
          authModal.hide();
          
          // Wait for session to be fully established and page to update
          setTimeout(() => {
            // Refresh the page to update authentication state
            window.location.reload();
            
            // After reload, the authenticated user can add to cart
            // Store the cart action in sessionStorage to be executed after reload
            if (action === 'add_to_cart') {
              sessionStorage.setItem('pendingCartAction', JSON.stringify({
                productId: productId,
                name: name,
                price: price,
                quantity: quantity,
                variantId: variantId,
                action: 'add_to_cart'
              }));
            } else if (action === 'whatsapp_order') {
              sessionStorage.setItem('pendingCartAction', JSON.stringify({
                productId: productId,
                name: name,
                price: price,
                quantity: quantity,
                variantId: variantId,
                action: 'whatsapp_order'
              }));
            }
          }, 1000);
        } else {
          throw new Error('Auto-login failed after registration');
        }
      });
    } else {
      // Show errors
      const registerError = document.getElementById('registerError');
      registerError.textContent = data.message || 'Registration failed';
      registerError.classList.remove('d-none');
      
      // Show field-specific errors
      if (data.errors) {
        Object.keys(data.errors).forEach(field => {
          const input = document.getElementById('reg_' + field);
          const errorDiv = document.getElementById('reg' + field.charAt(0).toUpperCase() + field.slice(1) + 'Error');
          if (input && errorDiv) {
            input.classList.add('is-invalid');
            errorDiv.textContent = data.errors[field];
          }
        });
      }
    }
  })
  .catch(error => {
    console.error('Register fetch error:', error);
    const registerError = document.getElementById('registerError');
    registerError.textContent = 'Error: ' + error.message;
    registerError.classList.remove('d-none');
  })
  .finally(() => {
    registerButton.disabled = false;
    registerSpinner.classList.add('d-none');
  });
});

// Check for pending cart actions after page load
document.addEventListener('DOMContentLoaded', function() {
  // Check if there's a pending cart action from login/registration
  const pendingAction = sessionStorage.getItem('pendingCartAction');
  if (pendingAction) {
    const actionData = JSON.parse(pendingAction);
    sessionStorage.removeItem('pendingCartAction');
    
    // Wait a bit more to ensure page is fully loaded
    setTimeout(() => {
      if (actionData.action === 'add_to_cart') {
        const image = document.querySelector(".gallery-top .swiper-slide-active img")?.src || "{% static 'Images/download.jpeg' %}";
        addItemToCart(actionData.name, actionData.price, actionData.productId, 
                     actionData.quantity, actionData.variantId, image);
      } else if (actionData.action === 'whatsapp_order') {
        const variantImage = document.querySelector(".color-option.active")?.src || null;
        const productUrl = `${window.location.origin}/products/${actionData.productId}/`;
        
        let message = `Hello, I would like to order the following product:\n`;
        message += `Product: ${actionData.name}\n`;
        message += `Price: Rs ${actionData.price.toFixed(2)} PKR\n`;
        message += `Quantity: ${actionData.quantity}\n`;
        if (actionData.variantId && variantImage) {
          message += `Variant: ${variantImage}\n`;
        }
        message += `Product Link: ${productUrl}\n`;
        message += ``;

        const whatsappNumber = '+923104505008';
        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');

        // Track the WhatsApp order action
        fetch(`/track-whatsapp-order/${actionData.productId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
          console.log('WhatsApp order tracked:', data);
          showNotification('Order request sent via WhatsApp!');
        })
        .catch(error => {
          console.error('Error tracking WhatsApp order:', error);
          showNotification('Order request sent, but tracking failed.', true);
        });
      }
    }, 500);
  }
});

// Toggle between login and register forms
document.getElementById('showRegister').addEventListener('click', function() {
  document.getElementById('loginFormContainer').classList.add('d-none');
  document.getElementById('registerFormContainer').classList.remove('d-none');
  
  // Clear any existing errors
  document.getElementById('loginError').classList.add('d-none');
  document.querySelectorAll('#loginForm input').forEach(input => {
    input.classList.remove('is-invalid');
  });
});

document.getElementById('showLogin').addEventListener('click', function() {
  document.getElementById('registerFormContainer').classList.add('d-none');
  document.getElementById('loginFormContainer').classList.remove('d-none');
  
  // Clear any existing errors
  document.getElementById('registerError').classList.add('d-none');
  document.querySelectorAll('#registerForm input').forEach(input => {
    input.classList.remove('is-invalid');
  });
});

// Clear modal data when closed
document.getElementById('authModal').addEventListener('hidden.bs.modal', function() {
  delete this.dataset.productId;
  delete this.dataset.name;
  delete this.dataset.price;
  delete this.dataset.quantity;
  delete this.dataset.variantId;
  delete this.dataset.action;
  
  // Reset forms
  document.getElementById('loginForm').reset();
  document.getElementById('registerForm').reset();
  
  // Hide errors
  document.getElementById('loginError').classList.add('d-none');
  document.getElementById('registerError').classList.add('d-none');
  
  // Remove invalid classes
  document.querySelectorAll('#loginForm input, #registerForm input').forEach(input => {
    input.classList.remove('is-invalid');
  });
  
  // Show login form by default
  document.getElementById('registerFormContainer').classList.add('d-none');
  document.getElementById('loginFormContainer').classList.remove('d-none');
});

// =========== OTHER FUNCTIONALITY ===========

// Share functionality
const shareModal = document.getElementById('shareModal');
const shareButtons = document.querySelectorAll('.share-button');
const closeShare = document.querySelector('.close-share');
let currentProductId = null;

shareButtons.forEach(button => {
  button.addEventListener('click', function() {
    currentProductId = this.dataset.productId;
    if (shareModal) {
      shareModal.classList.add("d-flex", "justify-content-center", "align-items-center");
    }
  });
});

if (closeShare) {
  closeShare.addEventListener('click', function() {
    shareModal.classList.remove("d-flex", "justify-content-center", "align-items-center");
  });
}

window.addEventListener('click', function(event) {
  if (event.target === shareModal) {
    shareModal.classList.remove("d-flex", "justify-content-center", "align-items-center");
  }
});

document.querySelectorAll('.share-option').forEach(option => {
  option.addEventListener('click', function() {
    const shareType = this.dataset.type;
    const productUrl = `${window.location.origin}/products/${currentProductId}/`;
    const name = document.querySelector('.add-to-cart')?.dataset.name || document.querySelector('.add-to-cart-unauth')?.dataset.name;
    const price = parseFloat(document.querySelector('.add-to-cart')?.dataset.price || document.querySelector('.add-to-cart-unauth')?.dataset.price);
    const quantity = parseInt(document.getElementById("quantity").value);
    const variantId = document.querySelector(".color-option.active")?.dataset.variantId || null;
    const variantImage = document.querySelector(".color-option.active")?.src || null;
    
    if (shareType === 'order-whatsapp') {
      let message = `Hello, I would like to order the following product:\n`;
      message += `Product: ${name}\n`;
      message += `Price: Rs ${price.toFixed(2)} PKR\n`;
      message += `Quantity: ${quantity}\n`;
      if (variantId && variantImage) {
        message += `Variant: ${variantImage}\n`;
      }
      message += `Product Link: ${productUrl}\n`;
      message += `Please provide further details to complete the order.`;

      const whatsappNumber = '+923104505008';
      const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');

      // Track WhatsApp order action
      fetch(`/track-whatsapp-order/${currentProductId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        console.log('WhatsApp order tracked:', data);
        showNotification('Order request sent via WhatsApp!');
      })
      .catch(error => {
        console.error('Error tracking WhatsApp order:', error);
        showNotification('Order request sent, but tracking failed.', true);
      });
    } else {
      switch(shareType) {
        case 'facebook':
          window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}`, '_blank');
          break;
        case 'twitter':
          window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(productUrl)}`, '_blank');
          break;
        case 'whatsapp':
          window.open(`https://wa.me/?text=${encodeURIComponent(`Check out this product: ${productUrl}`)}`, '_blank');
          break;
        case 'link':
          navigator.clipboard.writeText(productUrl)
            .then(() => showNotification('Link copied to clipboard!'))
            .catch(err => {
              console.error('Failed to copy link:', err);
              showNotification('Failed to copy link', true);
            });
          break;
      }

      fetch(`/share-product/${currentProductId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
      })
      .then(response => response.json())
      .then(data => {
        console.log('Share tracked:', data);
      })
      .catch(error => {
        console.error('Error tracking share:', error);
      });
    }
    
    shareModal.style.display = 'none';
  });
});

// Review form submission
document.getElementById('reviewForm').addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  
  fetch(this.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': csrftoken
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Review submitted successfully!');
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } else {
      showNotification('Error: ' + data.message, true);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('An error occurred while submitting the review', true);
  });
});

// Function to initialize Swiper based on screen size
function initSwipers() {
  try {
    let isLargeScreen = window.matchMedia("(min-width: 768px)").matches;

    if (window.galleryThumbs) window.galleryThumbs.destroy(true, true);
    if (window.galleryTop) window.galleryTop.destroy(true, true);

    window.galleryThumbs = new Swiper(".gallery-thumbs", {
      spaceBetween: 5,
      slidesPerView: 3,
      watchSlidesProgress: true,
      direction: isLargeScreen ? "vertical" : "horizontal",
      on: {
        init: function () {
          console.log("Thumbs Swiper initialized");
        }
      }
    });

    window.galleryTop = new Swiper(".gallery-top", {
      spaceBetween: 5,
      navigation: {
        nextEl: ".swiper-button-next",
        prevEl: ".swiper-button-prev",
      },
      thumbs: {
        swiper: window.galleryThumbs,
      },
      on: {
        init: function () {
          console.log("Main Swiper initialized");
        },
        slideChange: function () {
          let activeSlide = document.querySelector(".gallery-top .swiper-slide-active img");
          let newPrice = activeSlide?.getAttribute("data-price");
          if (newPrice) {
            document.getElementById("priceDisplay").innerHTML = `<strong class="fw-bold">RS:${newPrice}</strong>`;
          }
        }
      }
    });

    document.querySelectorAll(".gallery-thumbs .swiper-slide").forEach((thumbnail, index) => {
      thumbnail.addEventListener("click", function () {
        console.log("Thumbnail clicked:", index);
        window.galleryTop.slideTo(index);
      });
    });

    return { galleryThumbs: window.galleryThumbs, galleryTop: window.galleryTop };
  } catch (error) {
    console.error("Error initializing Swiper:", error);
    showNotification("Failed to initialize image gallery", true);
  }
}

// Initialize Swipers on DOM load
document.addEventListener('DOMContentLoaded', function() {
  initSwipers();
  fetchCartItems();
  updateCartCount();
  
  // Initialize Bootstrap tooltips if needed
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
});

// Reinitialize Swiper on resize
window.addEventListener("resize", function () {
  initSwipers();
});

// Color option selection
document.querySelectorAll('.color-option').forEach((img) => {
  img.addEventListener('click', function () {
    document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('active'));
    this.classList.add('active');
    let selectedImageSrc = this.getAttribute('src');
    let newPrice = this.getAttribute('data-price');
    let slideIndex = parseInt(this.getAttribute('data-slide-index'));
    let mainSlider = document.querySelector('.gallery-top .swiper-slide-active img');
    if (mainSlider) {
      mainSlider.src = selectedImageSrc;
      mainSlider.setAttribute('data-price', newPrice);
    }
    if (newPrice) {
      document.getElementById("priceDisplay").innerHTML = `<strong class="fw-bold">RS:${newPrice}</strong>`;
    }
    window.galleryTop.slideTo(slideIndex);
  });
});

// Initialize EasyZoom
var $easyzoom = $('.easyzoom').easyZoom();

// Refresh cart count periodically
setInterval(updateCartCount, 10000);
</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/easyzoom/2.5.2/easyzoom.min.js"></script>
</body>
</html>