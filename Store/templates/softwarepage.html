<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="{% static 'Images/circle.png' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ category.name }} - Projects</title>
    
    <meta name="description" content="Discover software projects built with HTML, CSS, JavaScript, Bootstrap, Django, and modern web app technologies. Perfect for students and professionals.">
    <meta name="keywords" content="software projects, HTML projects, CSS projects, JavaScript projects, Bootstrap projects, Django projects, web app projects, full stack projects, student projects, final year projects">
        <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'style.css' %}">
   
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" crossorigin="anonymous">
    <style>
        body {
            font-family: Arial, sans-serif;
            overflow-x: hidden;
        }
        .filtered-out {
            display: none !important;
        }
        .cart-sidebar {
            width: 100%;
            max-width: 390px;
            height: 100%;
            position: fixed;
            top: 0;
            right: -100%;
            background: #fff;
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
            transition: right 0.3s ease;
            z-index: 10000;
        }
        .cart-sidebar.open {
            right: 0;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            width: 350px;
        }
       .card-img-top {
    width: 100%;
    height: 200px;
    object-fit: contain;
    object-position: center;
}
        .card-body {
            text-align: center;
        }
        .btn-add-to-cart {
            background-color: #28a745;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-add-to-cart:hover {
            background-color: #218838;
        }
        #backToTop {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
        }
        #backToTop:hover {
            background-color: #0056b3;
        }
        @media (max-width: 767px) {
            .card-img-top {
                max-height: 150px;
            }
        }
        .badge-discount {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 800;
            z-index: 5;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
            animation: pulseDiscount 2s infinite;
        }
        @keyframes pulseDiscount {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    {% include 'Includes/navbar.html' %}

    <!-- Alert Container -->
    <div class="alert-container">
        <!-- Alerts will be inserted here -->
    </div>

    <div class="container-fluid bg-light">
        <div class="container px-2 px-md-3">
            <div class="row py-4">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="{% url 'home' %}" class="text-decoration-none fs-4">Home</a>
                        </li>
                        <li class="breadcrumb-item active fs-4">{{ category.name }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <div class="container px-2 px-md-0">
        <div class="row">
            <!-- Filters -->
            <div class="col-md-2 mt-0">
                <h3 class="fw-bold">Filters</h3>
                <button class="btn btn-dark d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#filterSection">
                    <i class="bi bi-funnel"></i> Filter
                </button>
                <div class="collapse d-md-block mt-3" id="filterSection">
                    <div class="filter-sidebar">
                        <h6 class="mt-3 fw-bold">Price</h6>
                        <input type="range" class="form-range" id="priceRange" min="0" max="100000" step="100" value="100000">
                        <p>Price: <span id="priceValue">Rs 0 - Rs 100,000</span> </p>
                    </div>
                </div>
            </div>

            <!-- Product List -->
            <div class="col-md-10">
                <h2 class="text-start mb-4">{{ category.name }} Projects</h2>
                <div class="row mt-3">
                    {% if products %}
                    {% for product in products %}
                    <div class="col-md-4 mb-4 product-card"
                         data-price="{{ product.price }}"
                         data-stock="{% if product.stock > 0 %}in{% else %}out{% endif %}"
                         data-category="{{ product.category.name }}">
                        <div class="card position-relative">
                            {% if product.discount_percentage > 0 %}
                            <span class="badge-discount">-{{ product.discount_percentage }}%</span>
                            {% endif %}
                            <img src="{{ product.main_image.url }}"
                                 class="card-img-top img-fluid img-thumbnail"
                                 alt="Product Image">
                            <div class="card-body text-start">
                                <h5>{{ product.name }}</h5>
                                <p>{{ product.short_description | truncatechars:30 }}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <a href="{% url 'product_detail' product.slug %}" class="btn btn-success">Show More</a>
                                    {% comment %} <button class="btn btn-add-to-cart"
                                            data-product-id="{{ product.id }}"
                                            data-name="{{ product.name }}"
                                            data-price="{{ product.price }}"
                                            data-image="{{ product.main_image.url }}">Add to Cart</button> {% endcomment %}
                                    <div class="price-box">
                                        {% if product.discount_percentage > 0 %}
                                        <div class="text-muted text-decoration-line-through small">Rs {{ product.price }}</div>
                                        <h4 class="text-danger mt-0 fw-bold">Rs {{ product.final_price }}</h4>
                                        {% else %}
                                        <h4 class="text-danger mt-1 fw-bold">Rs {{ product.price }}</h4>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="col-12">
                        <div class="alert alert-info text-center">
                            No products found in this category.
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div class="cart-sidebar" id="cartSidebar">
        <button class="btn-close float-end mt-3 me-3" id="closeCart"></button>
        <div class="p-3">
            <h5>Shopping Cart</h5>
        </div>
        <div id="cartItems" class="px-3"></div>
        <div class="p-3">
            <p><strong>Subtotal:</strong> Rs <span id="cartTotal">0</span> PKR</p>
            <a class="btn btn-success w-100" href="{% url 'checkout' %}">Checkout</a>
        </div>
    </div>

 <div class="position-fixed bottom-0 end-0 m-4" style="z-index:1000;">
  <!-- Small screens (icon only) -->
  <a href="https://wa.me/923104505008" target="_blank"
     class="btn btn-success rounded-circle shadow-lg d-flex align-items-center justify-content-center d-md-none"
     style="width:60px; height:60px;">
    <i class="bi bi-whatsapp fs-3 text-white"></i>
  </a>

  <!-- Medium & Large screens (icon + text) -->
  <a href="https://wa.me/923104505008" target="_blank"
     class="btn btn-success shadow-lg d-none d-md-flex align-items-center px-3 py-2">
    <i class="bi bi-whatsapp fs-3 text-white me-2"></i>
    <span class="fs-5 text-white fw-bold">Chat</span>
  </a>
</div>


    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get CSRF token for AJAX requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Back to Top Button
        {% comment %} const backToTopButton = document.getElementById("backToTop");
        window.onscroll = function () {
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                backToTopButton.style.display = "block";
            } else {
                backToTopButton.style.display = "none";
            }
        };
        backToTopButton.onclick = function () {
            window.scrollTo({
                top: 0,
                behavior: "smooth",
            });
        }; {% endcomment %}

        // Cart Functionality
        const cartSidebar = document.getElementById("cartSidebar");
        const cartItems = document.getElementById("cartItems");
        const cartTotal = document.getElementById("cartTotal");

        // Open Cart Sidebar when clicking the cart icons
        document.querySelectorAll("[id^=cartIcon]").forEach(icon => {
            icon.addEventListener("click", function (event) {
                event.preventDefault();
                openCart();
                fetchCartItems();
            });
        });

        // Close Sidebar
        document.getElementById("closeCart").addEventListener("click", function () {
            closeCart();
        });

        // Open Cart Sidebar
        function openCart() {
            cartSidebar.classList.add("open");
            document.body.style.overflow = 'hidden';
        }

        // Close Cart Sidebar
        function closeCart() {
            cartSidebar.classList.remove("open");
            document.body.style.overflow = '';
        }

        // Show alert message
        function showAlert(message, type) {
            const alertContainer = document.querySelector('.alert-container');
            const alertId = 'alert-' + Date.now();
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show shadow`;
            alert.role = 'alert';
            alert.id = alertId;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            alertContainer.appendChild(alert);

            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        }

        // Add Item to Cart
        document.querySelectorAll(".btn-add-to-cart").forEach(button => {
            button.addEventListener("click", function () {
                const productId = this.dataset.productId;
                const name = this.dataset.name;
                const price = parseFloat(this.dataset.price);
                const image = this.dataset.image;
                const quantity = 1;
                addItemToCart(name, price, productId, quantity, null, image);
                openCart();
            });
        });

        function addItemToCart(name, price, productId, quantity, variantId, image) {
            $.ajax({
                url: "{% url 'add_to_cart' %}",
                type: "POST",
                headers: {
                    'X-CSRFToken': csrftoken
                },
                data: {
                    product_id: productId,
                    quantity: quantity,
                    variant_id: variantId
                },
                success: function(response) {
                    if (response.success) {
                        fetchCartItems();
                        showAlert("Item added to cart!", "success");
                    } else {
                        console.error("Error adding item:", response.message);
                        showAlert("Error: " + response.message, "danger");
                    }
                },
                error: function(xhr) {
                    console.error("Error adding item to cart:", xhr.status, xhr.statusText);
                    showAlert("An error occurred while adding the item to the cart.", "danger");
                }
            });
        }

        // Fetch and display cart items
        function fetchCartItems() {
            $.ajax({
                url: "{% url 'get_cart' %}",
                type: "GET",
                success: function(response) {
                    cartItems.innerHTML = "";
                    let total = 0;
                    if (response.items && Array.isArray(response.items)) {
                        if (response.items.length === 0) {
                            cartItems.innerHTML = '<div class="text-center py-4"><p>Your cart is empty</p></div>';
                        } else {
                            response.items.forEach(item => {
                                const itemElement = document.createElement("div");
                                itemElement.classList.add("cart-item", "d-flex", "justify-content-between", "align-items-center", "mb-3", "p-2", "bg-light", "rounded");
                                itemElement.innerHTML = `
                                    <div class="d-flex align-items-center">
                                        <img src="${item.image || "{% static 'Images/download.jpeg' %}"}" alt="${item.name}" width="60" height="60" class="me-3 rounded">
                                        <div>
                                            <h6 class="mb-0">${item.name}</h6>
                                            <p class="mb-0">Rs ${item.price.toFixed(2)}</p>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-sm btn-outline-secondary minus-btn" data-item-id="${item.id}">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <span class="mx-2 quantity">${item.quantity}</span>
                                        <button class="btn btn-sm btn-outline-secondary plus-btn" data-item-id="${item.id}">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm delete-item ms-2" data-item-id="${item.id}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                `;
                                cartItems.appendChild(itemElement);
                                total += item.price * item.quantity;
                            });
                        }
                    }
                    cartTotal.textContent = total.toFixed(2);
                    updateCartCount();
                },
                error: function(xhr) {
                    console.error("Error fetching cart:", xhr.status, xhr.statusText);
                    showAlert("An error occurred while fetching the cart.", "danger");
                }
            });
        }

        // Update quantity in cart
        cartItems.addEventListener("click", function(e) {
            if (e.target.closest(".minus-btn") || e.target.closest(".plus-btn")) {
                const button = e.target.closest("button");
                const itemId = button.dataset.itemId;
                const change = button.classList.contains("minus-btn") ? -1 : 1;
                updateCartItemQuantity(itemId, change);
            }
            if (e.target.closest(".delete-item")) {
                const itemId = e.target.closest(".delete-item").dataset.itemId;
                removeCartItem(itemId);
            }
        });

        function updateCartItemQuantity(itemId, change) {
            $.ajax({
                url: "{% url 'update_cart' %}",
                type: "POST",
                headers: {
                    'X-CSRFToken': csrftoken
                },
                data: {
                    item_id: itemId,
                    change: change
                },
                success: function(response) {
                    if (response.success) {
                        fetchCartItems();
                        showAlert("Cart updated successfully!", "success");
                    } else {
                        console.error("Error updating item:", response.message);
                        showAlert("Error: " + response.message, "danger");
                    }
                },
                error: function(xhr) {
                    console.error("Error updating cart:", xhr.status, xhr.statusText);
                    showAlert("An error occurred while updating the cart.", "danger");
                }
            });
        }

        function removeCartItem(itemId) {
            $.ajax({
                url: "{% url 'remove_from_cart' %}",
                type: "POST",
                headers: {
                    'X-CSRFToken': csrftoken
                },
                data: {
                    item_id: itemId
                },
                success: function(response) {
                    if (response.success) {
                        fetchCartItems();
                        showAlert("Item removed from cart!", "success");
                    } else {
                        console.error("Error removing item:", response.message);
                        showAlert("Error: " + response.message, "danger");
                    }
                },
                error: function(xhr) {
                    console.error("Error removing item:", xhr.status, xhr.statusText);
                    showAlert("An error occurred while removing the item.", "danger");
                }
            });
        }

        // Update cart count
        function updateCartCount() {
            fetch("{% url 'cart_count' %}")
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.querySelectorAll('.cartCount').forEach(el => {
                        el.textContent = data.count || 0;
                        el.style.display = data.count > 0 ? 'inline-block' : 'none';
                    });
                })
                .catch(err => console.error('Error fetching cart count:', err));
        }

        // Filtering Products
        document.addEventListener("DOMContentLoaded", function () {
            const productCards = document.querySelectorAll(".product-card");
            const priceRange = document.getElementById("priceRange");
            const priceValue = document.getElementById("priceValue");

            function filterProducts() {
                const maxPrice = parseInt(priceRange.value) || 100000;
                const categoryFilters = Array.from(
                    document.querySelectorAll('[data-filter="category"]:checked')
                ).map(cb => cb.value);

                productCards.forEach(card => {
                    const price = parseFloat(card.dataset.price);
                    const category = card.dataset.category;

                    let show = true;
                    if (price > maxPrice) show = false;
                    if (categoryFilters.length > 0 && !categoryFilters.includes(category)) show = false;

                    card.classList.toggle("filtered-out", !show);
                });
            }

            if (priceRange && priceValue) {
                priceRange.addEventListener("input", () => {
                    priceValue.innerText = `Rs 0 - Rs ${priceRange.value}`;
                    filterProducts();
                });
            }
            document.querySelectorAll('[data-filter]').forEach(cb => 
                cb.addEventListener("change", filterProducts)
            );

            // Initial calls
            filterProducts();
            fetchCartItems();
            updateCartCount();
        });

        // Optionally refresh cart count every 10 seconds
        setInterval(updateCartCount, 10000);
    </script>
</body>
</html>